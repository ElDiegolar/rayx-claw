<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOPHIA // Multi-Agent Orchestrator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="/static/persona-manager.css" rel="stylesheet">
  <style>
    :root {
      --neon-pink: #ff2d95;
      --neon-cyan: #00f0ff;
      --neon-purple: #b829ff;
      --neon-green: #39ff14;
      --neon-amber: #ffaa00;
      --neon-red: #ff003c;
      --bg-dark: #0a0a0f;
      --bg-panel: #0d0d14;
      --bg-card: #111119;
      --border-dim: #1a1a2e;
      --text-dim: #4a4a6a;
      --text-mid: #8888aa;
      --text-bright: #e0e0f0;
    }

    body {
      font-family: 'Share Tech Mono', 'Fira Code', monospace;
      background: var(--bg-dark);
      color: var(--text-bright);
    }

    /* Scanline overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        transparent, transparent 2px,
        rgba(0, 0, 0, 0.03) 2px, rgba(0, 0, 0, 0.03) 4px
      );
      pointer-events: none;
      z-index: 9999;
    }

    /* Neon glow utilities */
    .glow-pink  { text-shadow: 0 0 8px var(--neon-pink), 0 0 20px rgba(255,45,149,0.3); }
    .glow-cyan  { text-shadow: 0 0 8px var(--neon-cyan), 0 0 20px rgba(0,240,255,0.3); }
    .glow-green { text-shadow: 0 0 8px var(--neon-green), 0 0 20px rgba(57,255,20,0.3); }

    .border-glow-pink { border-color: var(--neon-pink); box-shadow: 0 0 6px rgba(255,45,149,0.2); }
    .border-glow-cyan { border-color: var(--neon-cyan); box-shadow: 0 0 6px rgba(0,240,255,0.2); }

    /* Agent border accents */
    .agent-claude  { border-left: 2px solid var(--neon-pink); }
    .agent-minimax { border-left: 2px solid var(--neon-cyan); }
    .agent-system  { border-left: 2px solid var(--text-dim); }
    .agent-user    { border-left: 2px solid var(--neon-green); }
    .border-l-3    { border-left-width: 2px; }

    /* Scrollbar */
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-thumb { background: var(--neon-pink); border-radius: 2px; }
    #messages::-webkit-scrollbar-track { background: transparent; }

    pre { tab-size: 4; }

    .badge {
      font-family: 'Orbitron', monospace;
      font-size: 0.55rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 2px;
      border: 1px solid;
    }
    .badge-persona {
      background: rgba(255,45,149,0.1);
      color: var(--neon-pink);
      border-color: rgba(255,45,149,0.4);
    }
    .badge-minimax {
      background: rgba(0,240,255,0.1);
      color: var(--neon-cyan);
      border-color: rgba(0,240,255,0.4);
    }
    .badge-system {
      background: rgba(74,74,106,0.2);
      color: var(--text-dim);
      border-color: rgba(74,74,106,0.3);
    }
    .badge-user {
      background: rgba(57,255,20,0.1);
      color: var(--neon-green);
      border-color: rgba(57,255,20,0.4);
    }
    .badge-tool {
      background: rgba(255,170,0,0.1);
      color: var(--neon-amber);
      border-color: rgba(255,170,0,0.4);
    }

    .exchange-group {
      display: flex;
      flex-direction: column-reverse;
      gap: 0.5rem;
      border-bottom: 1px solid var(--border-dim);
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }
    .exchange-group:first-child { border-bottom: none; }

    /* Side-by-side layout for parallel agent streams */
    .parallel-agents-row {
      display: flex;
      gap: 0.5rem;
      width: 100%;
    }
    .parallel-agents-row > .msg-card {
      flex: 1;
      min-width: 0;
      max-height: 60vh;
      overflow-y: auto;
    }
    .parallel-agents-row > .msg-card::-webkit-scrollbar { width: 3px; }
    .parallel-agents-row > .msg-card::-webkit-scrollbar-thumb { background: var(--neon-cyan); border-radius: 2px; }
    .parallel-agents-row > .msg-card::-webkit-scrollbar-track { background: transparent; }

    .msg-card {
      background: var(--bg-card);
      border-radius: 3px;
      padding: 0.5rem 0.75rem;
    }

    /* Tool status dots */
    .tool-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .tool-dot.on  {
      background: var(--neon-green);
      box-shadow: 0 0 6px var(--neon-green), 0 0 12px rgba(57,255,20,0.3);
    }
    .tool-dot.off {
      background: var(--neon-red);
      box-shadow: 0 0 6px var(--neon-red), 0 0 12px rgba(255,0,60,0.3);
    }
    .tool-dot.unknown { background: var(--text-dim); }

    /* Token timer */
    .token-timer {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.05em;
      padding: 2px 8px;
      border: 1px solid var(--border-dim);
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .token-timer.ok {
      color: var(--neon-green);
      border-color: rgba(57,255,20,0.3);
    }
    .token-timer.warning {
      color: var(--neon-amber);
      border-color: rgba(255,170,0,0.3);
      animation: pulse-amber 2s infinite;
    }
    .token-timer.critical {
      color: var(--neon-red);
      border-color: rgba(255,0,60,0.4);
      animation: pulse-red 1s infinite;
    }
    @keyframes pulse-amber {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .tooltip-wrap { position: relative; }
    .tooltip-wrap .tooltip {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      right: -4px;
      background: var(--bg-panel);
      border: 1px solid var(--neon-cyan);
      box-shadow: 0 0 10px rgba(0,240,255,0.15);
      border-radius: 2px;
      padding: 6px 10px;
      font-size: 0.6rem;
      color: var(--text-mid);
      white-space: nowrap;
      z-index: 50;
      pointer-events: none;
    }
    .tooltip-wrap:hover .tooltip { display: block; }

    /* Settings panel */
    .settings-panel {
      transition: max-height 0.2s ease, opacity 0.2s ease;
      overflow: hidden;
    }
    .settings-panel.closed { max-height: 0; opacity: 0; }
    .settings-panel.open { max-height: 300px; opacity: 1; }

    /* Provider toggle */
    .provider-toggle {
      display: inline-flex;
      border: 1px solid var(--border-dim);
      border-radius: 3px;
      overflow: hidden;
    }
    .provider-toggle button {
      font-family: 'Orbitron', monospace;
      font-size: 0.55rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 5px 14px;
      background: transparent;
      color: var(--text-dim);
      border: none;
      cursor: pointer;
      transition: all 0.15s;
    }
    .provider-toggle button:not(:last-child) {
      border-right: 1px solid var(--border-dim);
    }
    .provider-toggle button.active-claude {
      background: rgba(255,45,149,0.15);
      color: var(--neon-pink);
      box-shadow: inset 0 0 12px rgba(255,45,149,0.1);
    }
    .provider-toggle button.active-minimax {
      background: rgba(0,240,255,0.15);
      color: var(--neon-cyan);
      box-shadow: inset 0 0 12px rgba(0,240,255,0.1);
    }
    .provider-toggle button:hover:not(.active-claude):not(.active-minimax) {
      background: rgba(255,255,255,0.03);
      color: var(--text-mid);
    }

    /* Input styling */
    .cyber-input {
      background: var(--bg-panel);
      border: 1px solid var(--border-dim);
      color: var(--text-bright);
      font-family: 'Share Tech Mono', monospace;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .cyber-input:focus {
      outline: none;
      border-color: var(--neon-pink);
      box-shadow: 0 0 8px rgba(255,45,149,0.2);
    }
    .cyber-input::placeholder { color: var(--text-dim); }

    .cyber-btn {
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      background: transparent;
      border: 1px solid var(--neon-pink);
      color: var(--neon-pink);
      transition: all 0.15s;
      cursor: pointer;
    }
    .cyber-btn:hover {
      background: rgba(255,45,149,0.1);
      box-shadow: 0 0 12px rgba(255,45,149,0.3);
    }
    .cyber-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .cyber-btn-stop {
      border-color: var(--neon-red);
      color: var(--neon-red);
    }
    .cyber-btn-stop:hover {
      background: rgba(255,0,60,0.15);
      box-shadow: 0 0 12px rgba(255,0,60,0.4);
    }
    .cyber-btn-sm {
      font-size: 0.6rem;
      padding: 4px 12px;
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
    }
    .cyber-btn-sm:hover {
      background: rgba(0,240,255,0.1);
      box-shadow: 0 0 8px rgba(0,240,255,0.3);
    }

    /* Activity spinner */
    .spinner { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Header divider line with neon gradient */
    .neon-border-b {
      border-bottom: 1px solid transparent;
      border-image: linear-gradient(90deg, var(--neon-pink), var(--neon-purple), var(--neon-cyan)) 1;
    }

    .dim-border-b { border-bottom: 1px solid var(--border-dim); }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="neon-border-b px-6 py-3 flex items-center justify-between shrink-0" style="background: var(--bg-panel)">
    <div class="flex items-center gap-3">
      <h1 id="header-title" class="text-sm font-black tracking-widest glow-pink" style="font-family:'Orbitron',monospace">SOPHIA</h1>
      <span class="text-xs" style="color: var(--text-dim)">// MULTI-AGENT ORCHESTRATOR</span>
      <span id="provider-badge" class="badge badge-persona" style="margin-left:4px">CLAUDE</span>
    </div>
    <div class="flex items-center gap-4">
      <!-- Tool status indicators -->
      <div id="tool-indicators" class="flex items-center gap-2"></div>
      <!-- Token timer -->
      <div class="tooltip-wrap">
        <div id="token-timer" class="token-timer ok" title="Click to refresh token">TOKEN --:--:--</div>
        <div class="tooltip">
          <span id="token-tooltip-text">OAuth token countdown</span>
        </div>
      </div>
      <!-- WS connection status -->
      <div class="flex items-center gap-2">
        <span id="status-dot" class="w-2 h-2 rounded-full" style="background: var(--text-dim)"></span>
        <span id="status-text" class="text-xs" style="color: var(--text-dim)">CONNECTING...</span>
      </div>
      <!-- Settings gear -->
      <button id="settings-toggle" class="transition-colors" style="color: var(--text-dim)" title="Settings">
        <svg class="w-4 h-4 hover:drop-shadow-[0_0_6px_rgba(0,240,255,0.5)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition: filter 0.2s">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Settings panel (collapsible) -->
  <div id="settings-panel" class="settings-panel closed dim-border-b" style="background: var(--bg-panel)">
    <div class="px-6 py-4 max-w-4xl mx-auto flex flex-col gap-3">
      <div class="flex items-center gap-4">
        <label class="text-xs" style="color: var(--text-dim); font-family:'Orbitron',monospace; font-size:0.6rem; letter-spacing:0.1em; min-width:70px">PERSONA</label>
        <button id="persona-manager-btn" class="cyber-btn cyber-btn-sm rounded">MANAGE</button>
        <span id="persona-status" class="text-xs" style="color: var(--neon-green)"></span>
      </div>
      <div class="flex items-center gap-4">
        <label class="text-xs" style="color: var(--text-dim); font-family:'Orbitron',monospace; font-size:0.6rem; letter-spacing:0.1em; min-width:70px">LEAD AI</label>
        <div id="provider-toggle" class="provider-toggle">
          <button data-provider="claude" class="active-claude">Claude</button>
          <button data-provider="minimax">MiniMax</button>
        </div>
        <span id="provider-model" class="text-xs" style="color: var(--text-dim)"></span>
        <span id="provider-status" class="text-xs" style="color: var(--neon-green)"></span>
      </div>
    </div>
  </div>

  <!-- Persona Manager Panel -->
  <div id="persona-panel" class="persona-panel closed" style="background: var(--bg-panel)">
    <div class="px-6 py-4">
      <!-- Grid view -->
      <div id="persona-grid-view">
        <div class="panel-header">
          <span class="panel-title">PERSONAS</span>
          <button id="persona-close-btn" class="btn-back">‚Üê BACK</button>
        </div>
        <div id="persona-grid" class="persona-grid"></div>
      </div>
      <!-- Editor view -->
      <div id="persona-editor-view" class="hidden">
        <div class="panel-header">
          <button id="persona-back-btn" class="btn-back">‚Üê BACK</button>
          <span id="persona-editor-title" class="panel-title">NEW PERSONA</span>
          <div style="width:60px"></div>
        </div>
        <div class="persona-editor">
          <!-- Tabs -->
          <div class="editor-tabs">
            <button class="editor-tab active" data-tab="identity">Identity</button>
            <button class="editor-tab" data-tab="personality">Personality</button>
            <button class="editor-tab" data-tab="role">Role</button>
            <button class="editor-tab" data-tab="guardrails">Guardrails</button>
            <button class="editor-tab" data-tab="voice">Voice</button>
            <button class="editor-tab" data-tab="ui">UI</button>
          </div>
          
          <!-- Identity Tab -->
          <div id="tab-identity" class="tab-content active">
            <div class="field-group">
              <label class="field-label">Name</label>
              <input type="text" id="p-name" class="field-input" placeholder="e.g., Sophia">
            </div>
            <div class="field-group">
              <label class="field-label">Tagline</label>
              <input type="text" id="p-tagline" class="field-input" placeholder="e.g., Multi-agent AI orchestrator">
            </div>
            <div class="field-group">
              <label class="field-label">Greeting</label>
              <input type="text" id="p-greeting" class="field-input" placeholder="e.g., Hey! I'm Sophia. How can I help?">
            </div>
          </div>

          <!-- Personality Tab -->
          <div id="tab-personality" class="tab-content">
            <div class="field-group">
              <label class="field-label">Tone</label>
              <input type="text" id="p-tone" class="field-input" placeholder="e.g., professional yet approachable">
            </div>
            <div class="field-group">
              <label class="field-label">Style</label>
              <input type="text" id="p-style" class="field-input" placeholder="e.g., concise and direct">
            </div>
            <div class="field-group">
              <label class="field-label">Traits (one per line)</label>
              <textarea id="p-traits" class="field-input" placeholder="e.g.,&#10;- Helpful and proactive&#10;- Uses emoji sparingly"></textarea>
            </div>
          </div>

          <!-- Role Tab -->
          <div id="tab-role" class="tab-content">
            <div class="field-group">
              <label class="field-label">Description</label>
              <textarea id="p-role-desc" class="field-input" placeholder="You are a capable AI assistant..."></textarea>
            </div>
            <div class="field-group">
              <label class="field-label">Instructions (one per line)</label>
              <textarea id="p-instructions" class="field-input" placeholder="e.g.,&#10;- Delegate tasks to sub-agents&#10;- Verify output before presenting"></textarea>
            </div>
          </div>

          <!-- Guardrails Tab -->
          <div id="tab-guardrails" class="tab-content">
            <div class="field-group">
              <label class="field-label">Do (one per line)</label>
              <textarea id="p-guardrails-do" class="field-input" placeholder="e.g.,&#10;- Verify agent output&#10;- Save context to memory"></textarea>
            </div>
            <div class="field-group">
              <label class="field-label">Don't (one per line)</label>
              <textarea id="p-guardrails-dont" class="field-input" placeholder="e.g.,&#10;- Expose API keys&#10;- Make up information"></textarea>
            </div>
          </div>

          <!-- Voice Tab -->
          <div id="tab-voice" class="tab-content">
            <div class="field-row">
              <div class="field-group">
                <label class="field-label">Voice Enabled</label>
                <select id="p-voice-enabled" class="field-input">
                  <option value="true">Enabled</option>
                  <option value="false">Disabled</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Edge TTS Voice</label>
                <input type="text" id="p-edge-voice" class="field-input" placeholder="en-US-AriaNeural">
              </div>
            </div>
            <div class="field-group">
              <label class="field-label">Voicebox Profile ID</label>
              <input type="text" id="p-voicebox-profile" class="field-input" placeholder="a8337146-...">
            </div>
          </div>

          <!-- UI Tab -->
          <div id="tab-ui" class="tab-content">
            <div class="field-row">
              <div class="field-group">
                <label class="field-label">Avatar Emoji</label>
                <input type="text" id="p-avatar-emoji" class="field-input" placeholder="ü§ñ">
              </div>
              <div class="field-group">
                <label class="field-label">Primary Color</label>
                <input type="text" id="p-primary-color" class="field-input" placeholder="#e94560">
              </div>
            </div>
            <div class="field-group">
              <label class="field-label">Theme</label>
              <select id="p-theme" class="field-input">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
            </div>
          </div>

          <!-- Actions -->
          <div class="editor-actions">
            <button id="persona-activate-btn" class="btn-save btn-activate">ACTIVATE</button>
            <button id="persona-save-btn" class="btn-save">SAVE</button>
            <button id="persona-delete-btn" class="btn-save btn-danger hidden">DELETE</button>
            <span id="persona-editor-status" class="status-msg"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="dim-border-b p-4 shrink-0" style="background: var(--bg-panel)">
    <form id="form" class="flex gap-3 max-w-4xl mx-auto">
      <input id="input" type="text" placeholder="// ENTER COMMAND..."
             autocomplete="off"
             class="cyber-input flex-1 rounded px-4 py-2.5 text-sm">
      <button id="send-btn" type="submit" class="cyber-btn px-6 py-2.5 rounded">
        EXEC
      </button>
      <button id="stop-btn" type="button" class="cyber-btn cyber-btn-stop px-6 py-2.5 rounded hidden">
        STOP
      </button>
    </form>
  </div>

  <!-- Activity indicator -->
  <div id="activity-bar" class="hidden dim-border-b px-6 py-2 shrink-0" style="background: rgba(255,45,149,0.03)">
    <div class="flex items-center gap-2">
      <div class="spinner w-3 h-3 border border-t-transparent rounded-full" style="border-color: var(--neon-pink); border-top-color: transparent"></div>
      <span id="activity-text" class="text-xs" style="color: var(--neon-pink); font-family:'Orbitron',monospace; font-size:0.6rem; letter-spacing:0.08em"></span>
    </div>
  </div>

  <!-- Messages -->
  <main id="messages" class="flex-1 overflow-y-auto px-6 py-4">
    <div id="placeholder" class="text-center text-xs py-12" style="color: var(--text-dim)">
      <div style="font-family:'Orbitron',monospace; font-size:0.65rem; letter-spacing:0.15em; margin-bottom:0.5rem" class="glow-pink">SYSTEM READY</div>
      <div>Multi-agent orchestrator online. Enter a command to begin.</div>
    </div>
  </main>

  <script>
    const messagesEl   = document.getElementById('messages');
    const placeholder  = document.getElementById('placeholder');
    const form         = document.getElementById('form');
    const input        = document.getElementById('input');
    const sendBtn      = document.getElementById('send-btn');
    const stopBtn      = document.getElementById('stop-btn');
    const statusDot    = document.getElementById('status-dot');
    const statusText   = document.getElementById('status-text');
    const activityBar  = document.getElementById('activity-bar');
    const activityText = document.getElementById('activity-text');
    const headerTitle  = document.getElementById('header-title');
    const toolIndicators = document.getElementById('tool-indicators');
    const settingsToggle = document.getElementById('settings-toggle');
    const settingsPanel  = document.getElementById('settings-panel');
    const personaStatus  = document.getElementById('persona-status');
    const tokenTimerEl   = document.getElementById('token-timer');
    const tokenTooltip   = document.getElementById('token-tooltip-text');

    let personaName = 'Sophia';
    let tokenExpiresAt = 0;
    let tokenHasRefresh = false;
    let currentProvider = 'claude';
    let providerOptions = [];

    // Persona manager state
    let personas = [];
    let activePersonaId = 'default';
    let editingPersonaId = null;

    const providerBadge   = document.getElementById('provider-badge');
    const providerToggle  = document.getElementById('provider-toggle');
    const providerModel   = document.getElementById('provider-model');
    const providerStatusEl = document.getElementById('provider-status');

    const AGENTS = {
      user:   { label: () => "You",      badgeClass: "badge-user",    borderClass: "agent-user"    },
      claude:  { label: () => personaName, badgeClass: 'badge-persona', borderClass: 'agent-claude'  },
      minimax: { label: () => 'MiniMax',   badgeClass: 'badge-minimax', borderClass: 'agent-minimax' },
      system:  { label: () => 'System',    badgeClass: 'badge-system',  borderClass: 'agent-system'  },
    };

    let ws = null;
    let currentBubble = null;
    let currentAgent  = null;
    let currentGroup  = null;
    let busy = false;
    // Map of bubbleKey -> DOM element for parallel streaming
    const activeBubbles = new Map();
    // Flex-row container for side-by-side sub-agent bubbles
    let currentAgentRow = null;

    /* ---- Settings panel ---- */

    settingsToggle.addEventListener('click', () => {
      settingsPanel.classList.toggle('closed');
      settingsPanel.classList.toggle('open');
    });

    /* ---- Persona Manager ---- */

    const personaPanel = document.getElementById('persona-panel');
    const personaGridView = document.getElementById('persona-grid-view');
    const personaEditorView = document.getElementById('persona-editor-view');
    const personaGrid = document.getElementById('persona-grid');
    const personaManagerBtn = document.getElementById('persona-manager-btn');
    const personaCloseBtn = document.getElementById('persona-close-btn');
    const personaBackBtn = document.getElementById('persona-back-btn');
    const personaEditorTitle = document.getElementById('persona-editor-title');
    const personaActivateBtn = document.getElementById('persona-activate-btn');
    const personaSaveBtn = document.getElementById('persona-save-btn');
    const personaDeleteBtn = document.getElementById('persona-delete-btn');
    const personaEditorStatus = document.getElementById('persona-editor-status');

    // Tab switching
    document.querySelectorAll('.editor-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    async function loadPersonas() {
      try {
        const r = await fetch('/api/personas');
        personas = await r.json();
        activePersonaId = personas.find(p => p.active)?.id || 'default';
        renderPersonaGrid();
      } catch (e) {
        console.error('Failed to load personas:', e);
      }
    }

    function renderPersonaGrid() {
      personaGrid.innerHTML = '';
      personas.forEach(p => {
        const card = document.createElement('div');
        card.className = 'persona-card' + (p.id === activePersonaId ? ' active' : '');
        card.innerHTML = `
          <span class="emoji">${p.avatar_emoji || 'ü§ñ'}</span>
          <div class="card-name">${p.name}</div>
          <div class="card-tagline">${p.tagline || ''}</div>
          ${p.id === activePersonaId ? '<span class="active-badge">ACTIVE</span>' : ''}
          <span class="color-dot" style="background:${p.primary_color || '#e94560'}"></span>
        `;
        card.addEventListener('click', () => openPersonaEditor(p.id));
        personaGrid.appendChild(card);
      });
      // Add "new" card
      const newCard = document.createElement('div');
      newCard.className = 'persona-card persona-card-new';
      newCard.innerHTML = '<span class="plus">+</span><span class="label">NEW PERSONA</span>';
      newCard.addEventListener('click', () => openPersonaEditor(null));
      personaGrid.appendChild(newCard);
    }

    function openPersonaEditor(id) {
      editingPersonaId = id;
      personaGridView.classList.add('hidden');
      personaEditorView.classList.remove('hidden');
      
      if (id) {
        const p = personas.find(x => x.id === id);
        personaEditorTitle.textContent = 'EDIT: ' + p.name.toUpperCase();
        personaDeleteBtn.classList.remove('hidden');
        personaActivateBtn.classList.remove('hidden');
        
        // Load data into fields
        document.getElementById('p-name').value = p.name || '';
        document.getElementById('p-tagline').value = p.tagline || '';
        document.getElementById('p-greeting').value = p.greeting || '';
        document.getElementById('p-tone').value = p.personality?.tone || '';
        document.getElementById('p-style').value = p.personality?.style || '';
        document.getElementById('p-traits').value = (p.personality?.traits || []).join('\n');
        document.getElementById('p-role-desc').value = p.role?.description || '';
        document.getElementById('p-instructions').value = (p.role?.instructions || []).join('\n');
        document.getElementById('p-guardrails-do').value = (p.guardrails?.do || []).join('\n');
        document.getElementById('p-guardrails-dont').value = (p.guardrails?.dont || []).join('\n');
        document.getElementById('p-voice-enabled').value = p.voice_enabled !== false ? 'true' : 'false';
        document.getElementById('p-edge-voice').value = p.voice?.edge_tts?.voice || 'en-US-AriaNeural';
        document.getElementById('p-voicebox-profile').value = p.voice?.voicebox?.profile_id || '';
        document.getElementById('p-avatar-emoji').value = p.avatar_emoji || 'ü§ñ';
        document.getElementById('p-primary-color').value = p.primary_color || '#e94560';
        document.getElementById('p-theme').value = p.theme || 'dark';
      } else {
        personaEditorTitle.textContent = 'NEW PERSONA';
        personaDeleteBtn.classList.add('hidden');
        personaActivateBtn.classList.add('hidden');
        // Clear fields
        ['p-name','p-tagline','p-greeting','p-tone','p-style','p-traits','p-role-desc','p-instructions','p-guardrails-do','p-guardrails-dont','p-edge-voice','p-voicebox-profile','p-avatar-emoji','p-primary-color'].forEach(id => {
          document.getElementById(id).value = '';
        });
        document.getElementById('p-voice-enabled').value = 'true';
        document.getElementById('p-theme').value = 'dark';
        document.getElementById('p-primary-color').value = '#e94560';
        document.getElementById('p-avatar-emoji').value = 'ü§ñ';
      }
      personaEditorStatus.textContent = '';
    }

    function closePersonaEditor() {
      editingPersonaId = null;
      personaEditorView.classList.add('hidden');
      personaGridView.classList.remove('hidden');
    }

    function collectPersonaData() {
      const parseList = (id) => document.getElementById(id).value.split('\n').filter(x => x.trim());
      return {
        name: document.getElementById('p-name').value || 'Unnamed',
        tagline: document.getElementById('p-tagline').value,
        greeting: document.getElementById('p-greeting').value,
        personality: {
          tone: document.getElementById('p-tone').value,
          style: document.getElementById('p-style').value,
          traits: parseList('p-traits'),
        },
        role: {
          description: document.getElementById('p-role-desc').value,
          instructions: parseList('p-instructions'),
        },
        guardrails: {
          do: parseList('p-guardrails-do'),
          dont: parseList('p-guardrails-dont'),
        },
        voice: {
          enabled: document.getElementById('p-voice-enabled').value === 'true',
          edge_tts: { voice: document.getElementById('p-edge-voice').value },
          voicebox: { profile_id: document.getElementById('p-voicebox-profile').value },
        },
        ui: {
          avatar_emoji: document.getElementById('p-avatar-emoji').value,
          primary_color: document.getElementById('p-primary-color').value,
          theme: document.getElementById('p-theme').value,
        },
      };
    }

    personaManagerBtn.addEventListener('click', () => {
      personaPanel.classList.toggle('closed');
      personaPanel.classList.toggle('open');
      if (personaPanel.classList.contains('open')) loadPersonas();
    });

    personaCloseBtn.addEventListener('click', () => {
      personaPanel.classList.remove('open');
      personaPanel.classList.add('closed');
    });

    personaBackBtn.addEventListener('click', closePersonaEditor);

    personaActivateBtn.addEventListener('click', async () => {
      if (!editingPersonaId) return;
      try {
        const r = await fetch('/api/personas/active', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: editingPersonaId }),
        });
        if (r.ok) {
          personaEditorStatus.textContent = 'ACTIVATED!';
          personaEditorStatus.className = 'status-msg success';
          activePersonaId = editingPersonaId;
          personaName = document.getElementById('p-name').value;
          headerTitle.textContent = personaName.toUpperCase();
          loadPersonas();
          // Also notify orchestrator via WebSocket reconnection
          if (ws) ws.close();
        }
      } catch (e) {
        personaEditorStatus.textContent = 'ERROR';
        personaEditorStatus.className = 'status-msg error';
      }
    });

    personaSaveBtn.addEventListener('click', async () => {
      const data = collectPersonaData();
      try {
        let r;
        if (editingPersonaId) {
          r = await fetch('/api/personas/' + editingPersonaId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
        } else {
          const newId = data.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
          r = await fetch('/api/personas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: newId, ...data }),
          });
        }
        if (r.ok) {
          personaEditorStatus.textContent = 'SAVED!';
          personaEditorStatus.className = 'status-msg success';
          loadPersonas();
          if (!editingPersonaId) {
            const result = await r.json();
            openPersonaEditor(result.id);
          }
        } else {
          const err = await r.json();
          personaEditorStatus.textContent = err.detail || 'ERROR';
          personaEditorStatus.className = 'status-msg error';
        }
      } catch (e) {
        personaEditorStatus.textContent = 'ERROR';
        personaEditorStatus.className = 'status-msg error';
      }
    });

    personaDeleteBtn.addEventListener('click', async () => {
      if (!editingPersonaId || editingPersonaId === 'default') return;
      if (!confirm('Delete this persona?')) return;
      try {
        const r = await fetch('/api/personas/' + editingPersonaId, { method: 'DELETE' });
        if (r.ok) {
          closePersonaEditor();
          loadPersonas();
        }
      } catch (e) {
        personaEditorStatus.textContent = 'DELETE ERROR';
        personaEditorStatus.className = 'status-msg error';
      }
    });

    /* ---- Provider toggle ---- */

    function updateProviderUI(provider, options) {
      currentProvider = provider;
      providerOptions = options || providerOptions;

      // Update toggle buttons
      providerToggle.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('active-claude', 'active-minimax');
        if (btn.dataset.provider === provider) {
          btn.classList.add(provider === 'claude' ? 'active-claude' : 'active-minimax');
        }
      });

      // Update header badge
      const opt = providerOptions.find(o => o.value === provider);
      providerBadge.textContent = opt ? opt.label.toUpperCase() : provider.toUpperCase();
      providerBadge.className = `badge ${provider === 'claude' ? 'badge-persona' : 'badge-minimax'}`;

      // Show model name
      if (opt) {
        providerModel.textContent = opt.model;
      }
    }

    providerToggle.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', async () => {
        const provider = btn.dataset.provider;
        providerStatusEl.textContent = 'SWITCHING...';
        try {
          const r = await fetch('/api/orchestrator', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ provider }),
          });
          const data = await r.json();
          updateProviderUI(data.provider, data.options);
          providerStatusEl.textContent = 'SWITCHED';
          setTimeout(() => providerStatusEl.textContent = '', 2000);
          // Reconnect WebSocket to use new provider
          if (ws) {
            ws.close();
            connect();
          }
        } catch (e) {
          providerStatusEl.textContent = 'ERROR';
        }
      });
    });

    /* ---- Orchestrator & WebSocket ---- */

    async function fetchPersona() {
      try {
        const r = await fetch('/api/persona');
        const data = await r.json();
        personaName = data.name;
        headerTitle.textContent = personaName.toUpperCase();
      } catch (e) {
        console.error('Failed to fetch persona:', e);
      }
    }

    async function fetchOrchestrator() {
      try {
        const r = await fetch('/api/orchestrator');
        const data = await r.json();
        updateProviderUI(data.provider, data.options);
      } catch (e) {
        console.error('Failed to fetch orchestrator:', e);
      }
    }

    async function fetchTokenInfo() {
      try {
        const r = await fetch('/api/token');
        const data = await r.json();
        tokenExpiresAt = data.expires_at * 1000;
        tokenHasRefresh = data.has_refresh;
        updateTokenTimer();
      } catch (e) {
        console.error('Failed to fetch token:', e);
      }
    }

    function updateTokenTimer() {
      if (!tokenExpiresAt) return;
      const remaining = tokenExpiresAt - Date.now();
      if (remaining <= 0) {
        tokenTimerEl.textContent = 'TOKEN EXPIRED';
        tokenTimerEl.className = 'token-timer critical';
        tokenTooltip.textContent = 'Click to refresh';
        return;
      }
      const hours = Math.floor(remaining / 3600000);
      const minutes = Math.floor((remaining % 3600000) / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      tokenTimerEl.textContent = `TOKEN ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      if (remaining < 300000) {
        tokenTimerEl.className = 'token-timer critical';
      } else if (remaining < 600000) {
        tokenTimerEl.className = 'token-timer warning';
      } else {
        tokenTimerEl.className = 'token-timer ok';
      }
    }

    tokenTimerEl.addEventListener('click', async () => {
      tokenTimerEl.textContent = 'REFRESHING...';
      try {
        await fetch('/api/token/refresh', { method: 'POST' });
        await fetchTokenInfo();
      } catch (e) {
        tokenTimerEl.textContent = 'REFRESH ERROR';
      }
    });

    async function fetchStatus() {
      try {
        const r = await fetch('/api/status');
        const statuses = await r.json();
        toolIndicators.innerHTML = '';
        for (const [key, info] of Object.entries(statuses)) {
          const dot = document.createElement('div');
          dot.className = `tool-dot ${info.ok ? 'on' : 'off'}`;
          dot.title = info.desc;
          toolIndicators.appendChild(dot);
        }
      } catch (e) {
        console.error('Failed to fetch status:', e);
      }
    }

    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        statusDot.style.background = 'var(--neon-green)';
        statusText.textContent = 'CONNECTED';
        statusText.style.color = 'var(--neon-green)';
      };

      ws.onclose = () => {
        statusDot.style.background = 'var(--neon-red)';
        statusText.textContent = 'DISCONNECTED';
        statusText.style.color = 'var(--neon-red)';
        ws = null;
        // Reconnect after 3s
        setTimeout(connect, 3000);
      };

      ws.onerror = (e) => {
        console.error('WebSocket error:', e);
      };

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        handleWSMessage(msg);
      };
    }

    function handleWSMessage(msg) {
      if (msg.type === 'history') {
        // Replay history on connect
        placeholder.remove();
        messagesEl.innerHTML = '';
        for (const exchange of msg.history) {
          // User message
          addMessage({ agent: 'user', content: exchange.user });
          // Assistant messages (could be multiple for parallel)
          if (exchange.assistant && Array.isArray(exchange.assistant)) {
            for (const a of exchange.assistant) {
              addMessage({ agent: a.agent, content: a.content });
            }
          } else if (typeof exchange.assistant === 'string') {
            // Old format: assistant is just a string
            addMessage({ agent: 'minimax', content: exchange.assistant });
          } else if (exchange.assistant) {
            addMessage({ agent: exchange.assistant.agent || 'minimax', content: exchange.assistant.content || '' });
          }
        }
        return;
      }

      const agent = msg.agent || 'system';
      const cfg = AGENTS[agent] || AGENTS.system;

      if (msg.type === 'chunk' || msg.type === 'stream') {
        // Streaming chunk
        const bubbleKey = agent;
        let bubble = activeBubbles.get(bubbleKey);
        if (!bubble) {
          bubble = createBubble(agent);
          activeBubbles.set(bubbleKey, bubble);
        }
        const content = bubble.querySelector('.msg-content');
        content.innerHTML += msg.content;
        content.scrollTop = content.scrollHeight;
        return;
      }

      if (msg.type === 'message' || msg.type === 'done') {
        // Final message
        if (msg.content) {
          addMessage({ agent, content: msg.content });
        }
        if (msg.type === 'done') {
          // End of response chain
          busy = false;
          sendBtn.classList.remove('hidden');
          stopBtn.classList.add('hidden');
          activityBar.classList.add('hidden');
          activeBubbles.clear();
        }
        return;
      }

      if (msg.type === 'thinking') {
        // Claude thinking - show in bubble
        const bubbleKey = agent;
        let bubble = activeBubbles.get(bubbleKey);
        if (!bubble) {
          bubble = createBubble(agent);
          activeBubbles.set(bubbleKey, bubble);
        }
        const content = bubble.querySelector('.msg-content');
        // Show thinking indicator
        content.innerHTML += '<span class="text-xs" style="color:var(--text-dim)">[thinking...]</span>';
        return;
      }
    }

    function createBubble(agent) {
      const cfg = AGENTS[agent] || AGENTS.system;
      const bubble = document.createElement('div');
      bubble.className = `msg-card ${cfg.borderClass}`;
      bubble.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <span class="badge ${cfg.badgeClass}">${cfg.label()}</span>
        </div>
        <div class="msg-content text-sm" style="white-space:pre-wrap;word-break:break-word"></div>
      `;
      // Create new group if needed
      if (!currentGroup || currentGroup.querySelectorAll('.msg-card').length >= 2) {
        currentGroup = document.createElement('div');
        currentGroup.className = 'exchange-group';
        messagesEl.insertBefore(currentGroup, messagesEl.firstChild);
      }
      currentGroup.appendChild(bubble);
      return bubble;
    }

    function addMessage({ agent, content }) {
      const cfg = AGENTS[agent] || AGENTS.system;
      const bubble = document.createElement('div');
      bubble.className = `msg-card ${cfg.borderClass}`;
      bubble.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <span class="badge ${cfg.badgeClass}">${cfg.label()}</span>
        </div>
        <div class="msg-content text-sm" style="white-space:pre-wrap;word-break:break-word">${content}</div>
      `;
      if (!currentGroup || currentGroup.querySelectorAll('.msg-card').length >= 2) {
        currentGroup = document.createElement('div');
        currentGroup.className = 'exchange-group';
        messagesEl.insertBefore(currentGroup, messagesEl.firstChild);
      }
      currentGroup.appendChild(bubble);
      messagesEl.scrollTop = 0;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || busy) return;
      busy = true;
      input.value = '';
      placeholder.remove();
      sendBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
      activityBar.classList.remove('hidden');
      activityText.textContent = 'PROCESSING...';

      addMessage({ agent: 'user', content: text });

      ws.send(JSON.stringify({ type: 'message', content: text }));
    });

    stopBtn.addEventListener('click', () => {
      ws.send(JSON.stringify({ type: 'cancel' }));
    });

    /* ---- Init ---- */

    fetchPersona();
    fetchOrchestrator();
    fetchTokenInfo();
    fetchStatus();
    connect();

    // Periodic updates
    setInterval(fetchTokenInfo, 1000);
    setInterval(fetchStatus, 30000);

    // Hide panels on outside click
    document.addEventListener('click', (e) => {
      if (!settingsPanel.contains(e.target) && !settingsToggle.contains(e.target)) {
        settingsPanel.classList.add('closed');
        settingsPanel.classList.remove('open');
      }
    });
  </script>
</body>
</html>
